name: Deploy Web & Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    name: Build Android APK
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Install dependencies
      working-directory: mobile
      run: flutter pub get
      
    - name: Build APK
      working-directory: mobile
      run: flutter build apk --release
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: cropguard-ai-release-apk
        path: mobile/build/app/outputs/flutter-apk/app-release.apk
        
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/v') || contains(github.event.head_commit.message, '[release]')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: CropGuard AI v1.0.${{ github.run_number }}
        files: |
          mobile/build/app/outputs/flutter-apk/app-release.apk
        body: |
          ## ğŸŒ± CropGuard AI Release v1.0.${{ github.run_number }}
          
          ### ğŸ“± Download Android App
          - **Android APK**: See attached `app-release.apk`
          - **Web Version**: [Live Demo](https://cropguard-ai.vercel.app)
          
          ### âœ… Features
          - âœ… JPEG & PNG image upload support
          - âœ… Custom plant name input (not limited to predefined crops)  
          - âœ… AI-powered disease detection using Groq Vision API
          - âœ… Real-time camera capture
          - âœ… Treatment recommendations
          - âœ… Cross-platform (Android app + Web interface)
          
          ### ğŸ“‹ Installation Instructions
          1. Download `app-release.apk` from this release
          2. Enable "Install from unknown sources" on your Android device:
             - Settings â†’ Security â†’ Unknown Sources (Android 7 and below)
             - Settings â†’ Apps & notifications â†’ Special app access â†’ Install unknown apps (Android 8+)
          3. Install the APK file
          4. Open CropGuard AI and start scanning plants!
          
          ### ğŸŒ Web Version
          No installation required - visit: https://cropguard-ai.vercel.app
          
          ### ğŸ”§ Technical Details
          - **Flutter Version**: 3.24.0
          - **Target SDK**: Android 21+ (Android 5.0+)
          - **APK Size**: ~15-20MB
          - **Permissions**: Camera, Storage, Internet
          
          ### ğŸ› Issues or Questions?
          - Report bugs: [GitHub Issues](https://github.com/sibby-killer/cropguard-ai/issues)
          - Documentation: [README](https://github.com/sibby-killer/cropguard-ai#readme)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-web:
    runs-on: ubuntu-latest
    name: Deploy to Vercel
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        vercel-args: '--prod'